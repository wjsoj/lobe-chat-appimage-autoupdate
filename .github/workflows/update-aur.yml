name: Update AUR Package

on:
  # æ›´é¢‘ç¹çš„å®šæ—¶æ£€æŸ¥æ¥å¿«é€Ÿå“åº”æ–°release
  schedule:
  - cron: '0 */10 * * *' # æ¯10å°æ—¶æ£€æŸ¥ä¸€æ¬¡

  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  check-and-find:
    runs-on: ubuntu-latest
    outputs:
      should_update: ${{ steps.check.outputs.should_update }}
      latest_version: ${{ steps.check.outputs.latest_version }}
      appimage_url: ${{ steps.check.outputs.appimage_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for updates and find available version
        id: check
        run: |
          echo "ðŸ” æ£€æŸ¥LobeChatæ–°ç‰ˆæœ¬..."
          
          # æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "ðŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼šå¿½ç•¥å½“å‰ç‰ˆæœ¬å¯¹æ¯”ï¼Œå›žæº¯æŸ¥æ‰¾æœ€è¿‘å¯ç”¨çš„ AppImage"
          fi
          
          # æŸ¥æ‰¾æœ‰æž„å»ºäº§ç‰©çš„æœ€æ–°ç‰ˆæœ¬
          echo "ðŸ” æŸ¥æ‰¾æœ‰æž„å»ºäº§ç‰©çš„æœ€æ–°ç‰ˆæœ¬..."
          
          # èŽ·å–æœ€è¿‘20ä¸ªreleases
          releases_json=$(curl -sSL "https://api.github.com/repos/lobehub/lobe-chat/releases?per_page=20")
          
          # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰AppImageçš„ç‰ˆæœ¬
          latest_available_version=""
          appimage_url=""
          
          # æå–æ‰€æœ‰tagåç§°åˆ°æ•°ç»„
          tag_list=$(echo "$releases_json" | grep '"tag_name":' | sed 's/.*"tag_name": *"\([^"]*\)".*/\1/')
          
          # é€ä¸ªæ£€æŸ¥æ¯ä¸ªç‰ˆæœ¬
          for tag_name in $tag_list; do
            if [ -z "$tag_name" ]; then
              continue
            fi
            
            version=${tag_name#v}  # ç§»é™¤vå‰ç¼€
            echo "ðŸ“¦ æ£€æŸ¥ç‰ˆæœ¬: $version"
            
            # èŽ·å–è¯¥ç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯
            release_json=$(curl -sSL "https://api.github.com/repos/lobehub/lobe-chat/releases/tags/$tag_name")
            
            # æŸ¥æ‰¾AppImage asset - æ›´ç²¾ç¡®çš„åŒ¹é…æ¨¡å¼
            appimage_asset=$(echo "$release_json" | grep -o '"browser_download_url": *"[^"]*\.AppImage"' | sed 's/.*"browser_download_url": *"\([^"]*\)".*/\1/' | head -1)
            
            if [ -n "$appimage_asset" ]; then
              # éªŒè¯æ–‡ä»¶ç¡®å®žå¯ä»¥ä¸‹è½½
              echo "ðŸ” éªŒè¯AppImage: $appimage_asset"
              # è·Ÿéš 3xx é‡å®šå‘å¹¶ä»…éªŒè¯å¯è¾¾æ€§
              if curl -sIL --retry 2 --fail "$appimage_asset" -o /dev/null; then
                echo "âœ… æ‰¾åˆ°å¯ç”¨çš„æž„å»ºäº§ç‰©: $version"
                echo "ðŸ“ AppImage URL: $appimage_asset"
                latest_available_version="$version"
                appimage_url="$appimage_asset"
                break
              else
                echo "âš ï¸  ç‰ˆæœ¬ $version çš„AppImageæ— æ³•è®¿é—®"
              fi
            else
              echo "âš ï¸  ç‰ˆæœ¬ $version æ²¡æœ‰AppImageæ–‡ä»¶"
            fi
          done
          
          if [ -z "$latest_available_version" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯ç”¨çš„æž„å»ºäº§ç‰©"
            echo "should_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“¦ å¯ç”¨ç‰ˆæœ¬: $latest_available_version"
          echo "ðŸ“ AppImage URL: $appimage_url"
          echo "latest_version=$latest_available_version" >> $GITHUB_OUTPUT
          echo "appimage_url=$appimage_url" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥å½“å‰ç‰ˆæœ¬ï¼ˆå¼ºåˆ¶æ›´æ–°æ—¶è·³è¿‡ï¼‰
          if [ "${{ github.event.inputs.force_update }}" != "true" ] && [ -f "PKGBUILD" ]; then
            current_version=$(grep '^pkgver=' PKGBUILD | cut -d'=' -f2)
            echo "ðŸ“‹ å½“å‰ç‰ˆæœ¬: $current_version"
            
            if [ "$latest_available_version" = "$current_version" ]; then
              echo "âœ… ç‰ˆæœ¬å·²æ˜¯æœ€æ–°"
              echo "should_update=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "ðŸ†• å‘çŽ°æ–°ç‰ˆæœ¬éœ€è¦æ›´æ–°"
          echo "should_update=true" >> $GITHUB_OUTPUT

  update:
    needs: check-and-find
    runs-on: ubuntu-latest
    if: needs.check-and-find.outputs.should_update == 'true'
    env:
      AUR_REPO: lobe-chat-appimage
      GIT_AUTHOR_NAME: wjsoj
      GIT_AUTHOR_EMAIL: wjs@wjsphy.top
      GIT_COMMITTER_NAME: wjsoj
      GIT_COMMITTER_EMAIL: wjs@wjsphy.top
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download AppImage & LICENSE
        id: download
        run: |
          version="${{ needs.check-and-find.outputs.latest_version }}"
          appimage_url="${{ needs.check-and-find.outputs.appimage_url }}"
          if [ -z "$appimage_url" ]; then
            echo "âŒ appimage_url ä¸ºç©ºï¼Œåœæ­¢æ‰§è¡Œä»¥é¿å…ä¸‹è½½é”™è¯¯ã€‚"
            exit 1
          fi
          
          # Clean any existing downloads to avoid cache issues
          rm -f LobeHub-Beta-*.AppImage LICENSE lobe-chat.png
          
          # Download with cache-busting and retry logic
          echo "Downloading AppImage..."
          curl -L --retry 3 --fail -H "Cache-Control: no-cache" "$appimage_url" -o "LobeHub-Beta-${version}.AppImage"
          echo "Downloading LICENSE..."
          curl -L --retry 3 --fail -H "Cache-Control: no-cache" "https://raw.githubusercontent.com/lobehub/lobe-chat/v${version}/LICENSE" -o LICENSE
          echo "Downloading icon..."
          curl -L --retry 3 --fail -H "Cache-Control: no-cache" "https://raw.githubusercontent.com/lobehub/lobe-chat/v${version}/apps/desktop/resources/tray.png" -o lobe-chat.png
          
          # Verify downloads completed
          ls -la "LobeHub-Beta-${version}.AppImage" LICENSE lobe-chat.png
          
          # Calculate checksums
          sha_appimage=$(sha256sum "LobeHub-Beta-${version}.AppImage" | awk '{print $1}')
          sha_license=$(sha256sum LICENSE | awk '{print $1}')
          sha_icon=$(sha256sum lobe-chat.png | awk '{print $1}')
          
          echo "AppImage SHA256: $sha_appimage"
          echo "LICENSE SHA256: $sha_license"
          echo "Icon SHA256: $sha_icon"
          
          echo "sha_appimage=$sha_appimage" >> $GITHUB_OUTPUT
          echo "sha_license=$sha_license" >> $GITHUB_OUTPUT
          echo "sha_icon=$sha_icon" >> $GITHUB_OUTPUT

      - name: Update PKGBUILD
        run: |
          ver="${{ needs.check-and-find.outputs.latest_version }}"
          sha_appimage="${{ steps.download.outputs.sha_appimage }}"
          sha_license="${{ steps.download.outputs.sha_license }}"
          sha_icon="${{ steps.download.outputs.sha_icon }}"
          
          echo "Updating PKGBUILD with version $ver..."
          
          # Update version
          sed -i "s/^pkgver=.*/pkgver=$ver/" PKGBUILD
          
          # Replace checksums by specific placeholders to avoid conflicts
          sed -i "s/APPIMAGE_SHA256/$sha_appimage/" PKGBUILD
          sed -i "s/LICENSE_SHA256/$sha_license/" PKGBUILD  
          sed -i "s/ICON_SHA256/$sha_icon/" PKGBUILD
          
          echo "Updated PKGBUILD contents:"
          grep -E 'pkgver=|sha256sums' -A 3 PKGBUILD

      - name: Generate .SRCINFO
        run: |
          docker run --rm -v "$PWD":/work -w /work archlinux:base-devel bash -lc "pacman -Sy --noconfirm base-devel git && useradd -m builder && chown -R builder:builder /work && su builder -c 'makepkg --printsrcinfo > .SRCINFO'"
          sudo chown -R $(whoami):$(whoami) .

      - name: Configure AUR SSH key
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          cat >> ~/.ssh/config <<EOF
          Host aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking accept-new
          EOF

      - name: Push to AUR
        run: |
          # Configure git globally to avoid .git/config permission issues
          git config --global user.name "$GIT_AUTHOR_NAME"
          git config --global user.email "$GIT_AUTHOR_EMAIL"
          git config --global --add safe.directory "*"
          
          # Clone AUR repo to separate directory to avoid subdirectory conflicts
          git clone ssh://aur@aur.archlinux.org/${AUR_REPO}.git aur-repo
          cd aur-repo
          
          cp ../PKGBUILD .
          cp ../.SRCINFO .
          cp ../LICENSE .
          
          git add PKGBUILD .SRCINFO LICENSE
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update to ${{ needs.check-and-find.outputs.latest_version }}"
            git push origin master
          fi
